<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jonathan Jayes">
<meta name="dcterms.date" content="2025-03-11">

<title>DRAFT: Analysis for a Solar PV &amp; Battery System (South Africa) – Interlude One</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script data-goatcounter="https://j0nathan.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>
<style>
.cell-output-stdout code {
  word-break: break-wor !important;
  white-space: pre-wrap !important;
}
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/favicon_logo.ico" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Interlude One</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../content/phd-planning.html"> 
<span class="menu-text">PhD planning</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../content/teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../content/research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../content/publications.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../content/data.html"> 
<span class="menu-text">Data</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-web-apps" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Web Apps</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-web-apps">    
        <li>
    <a class="dropdown-item" href="http://jonathan-jayes.shinyapps.io/gumtree-price-explorer">
 <span class="dropdown-text">Second Hand Car Price Comparison Tool</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/j-jayes/production-functions">
 <span class="dropdown-text">Production Functions Shiny App</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/j-jayes/NBER-methods">
 <span class="dropdown-text">Economics literature explorer</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/j-jayes/Roses-Wolf-database-on-regional-GDP">
 <span class="dropdown-text">Europe’s Regional Development Explorer</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-fun-stuff" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Fun stuff</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-fun-stuff">    
        <li>
    <a class="dropdown-item" href="https://j-jayes.github.io/recipes/">
 <span class="dropdown-text">My personal cookbook</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../content/generative-ai-articles-listing.html">
 <span class="dropdown-text">Generative AI reports</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/j-jayes/interlude-one"> 
<span class="menu-text"><i class="fa-brands fa-github" aria-label="github"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prompt" id="toc-prompt" class="nav-link active" data-scroll-target="#prompt">Prompt</a></li>
  <li><a href="#response" id="toc-response" class="nav-link" data-scroll-target="#response">Response</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#load-requirements-and-backup-capacity" id="toc-load-requirements-and-backup-capacity" class="nav-link" data-scroll-target="#load-requirements-and-backup-capacity">Load Requirements and Backup Capacity</a></li>
  <li><a href="#solar-pv-array-sizing" id="toc-solar-pv-array-sizing" class="nav-link" data-scroll-target="#solar-pv-array-sizing">Solar PV Array Sizing</a></li>
  <li><a href="#battery-storage-system" id="toc-battery-storage-system" class="nav-link" data-scroll-target="#battery-storage-system">Battery Storage System</a></li>
  <li><a href="#inverter-and-balance-of-system-components" id="toc-inverter-and-balance-of-system-components" class="nav-link" data-scroll-target="#inverter-and-balance-of-system-components">Inverter and Balance of System Components</a></li>
  <li><a href="#financial-analysis" id="toc-financial-analysis" class="nav-link" data-scroll-target="#financial-analysis">Financial Analysis</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  <li><a href="#streamlit-application" id="toc-streamlit-application" class="nav-link" data-scroll-target="#streamlit-application">Streamlit Application</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DRAFT: Analysis for a Solar PV &amp; Battery System (South Africa)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jonathan Jayes </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 11, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>I asked GPT-4.5 with deep research to investigate a solar system for me, in order to test its capabilities, inspired by a post by Timothy B. Lee titled in a somewhat clickbait manner, <a href="https://www.understandingai.org/p/these-experts-were-stunned-by-openai"><em>These experts were stunned by OpenAI Deep Research</em></a>. I was interested to read that the experts Timothy consulted were impressed with the domain specific knowledge shown by the model, searching widely across the web for information to answer the expert’s questions ranging from law to coding, to construction.</p>
<p>Much like <a href="https://interludeone.com/posts/2025-02-23-transit-trek/transit-trek">my post on public transport between airports and city centers</a>, as each new iteration of LLM is announced, I have asked the models to investigate quite a complex domestic engineering problem; specifying a solar system for a house in South Africa, and creating a mechanism to calculate the payback time of the system.</p>
<p>This post details the output that I received from GPT 4.5 Deep Research, and the analysis of the solar system that it proposed.</p>
<p>I would really love some feedback on the <a href="https://solar-systems.streamlit.app/">Streamlit application that it built</a>, so please do comment on the LinkedIn post (when it is up).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/solar-system-1.png" class="img-fluid figure-img"></p>
<figcaption>Screenshot of the Streamlit app</figcaption>
</figure>
</div>
<section id="prompt" class="level2">
<h2 class="anchored" data-anchor-id="prompt">Prompt</h2>
<p>Following <a href="https://blog.tobiaszwingmann.com/p/5-principles-for-writing-effective-prompts">Tobias Zwingmann’s guide</a> to prompting Large Language Models, I provided the following prompt to GPT-4.5:</p>
<blockquote class="blockquote">
<p>Role: you’re an expert on domestic solar energy systems.</p>
<p>Goal: I want you to conduct some research for me, and write an engineering report. I am trying to decide on a solar panel and battery system to install in my freestanding house in South Africa.</p>
<p>Tasks: There are a few considerations;</p>
<ul>
<li><p>I need to understand the size of the system I need to run everything electric in my house, except water heating and air conditioning,</p></li>
<li><p>I need to understand what the lifespan of the system will be,</p></li>
<li><p>Using this, I need to understand how long the payback period would be, considering the cost of installing the system, the savings on electricity while the system is in use, and the opportunity cost of that money invested in a high-yield savings account.</p></li>
</ul>
<p>Details: Say that I live in a house that has a roof conducive to installing panels, that I pay a per kilowatt rate for my electricity from the grid and that I cannot sell back to the grid at the moment.</p>
</blockquote>
</section>
<section id="response" class="level2">
<h2 class="anchored" data-anchor-id="response">Response</h2>
<p>Here is the response I received:</p>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p>This report presents an engineering analysis for a solar panel and battery system to power a freestanding house in South Africa. The homeowner’s goal is to supply <strong>30 kWh of electricity per day</strong> and have <strong>48 hours (2 days) of backup</strong> power for outages. The system will be grid-connected (for reliability) but <strong>excess solar energy cannot be fed back</strong> into the grid. All components are selected for efficiency and cost-effectiveness within a <strong>budget of R200,000</strong>. We outline the system sizing (solar panels, battery bank, inverter), component lifespans, and a financial analysis including payback period, electricity bill savings, and the opportunity cost of capital (at 2% above inflation).</p>
</section>
<section id="load-requirements-and-backup-capacity" class="level3">
<h3 class="anchored" data-anchor-id="load-requirements-and-backup-capacity">Load Requirements and Backup Capacity</h3>
<p><strong>Daily Energy Usage:</strong> The average daily consumption is 30 kWh, which is in line with Eskom’s estimate of ~30 kWh for a typical household (<a href="https://revov.co.za/news/load-shedding-solutions-what-size-backup-battery-do-i-need/#:~:text=According%20to%20Eskom%2C%20the%20national,differ%20considerably%20from%20this%20average">Load-Shedding Solutions | What Size Backup Battery Do I Need? - REVOV Battery Backup Power Solutions</a>). This includes all household loads (lighting, appliances, etc.). To be fully self-sufficient on solar, the system must generate roughly this amount each day on average.</p>
<p><strong>Backup for 48 Hours:</strong> To power the home for 2 full days of autonomy (30 kWh/day × 2 days), <strong>approximately 60 kWh of usable energy storage</strong> is required if there were no solar input. In practice, during a daytime outage the solar panels will still produce power (if the sun is shining) to help supply loads and recharge the batteries. However, the battery bank must be sized to carry the house through <strong>two nights and periods of low sun</strong>. We will design for ~60 kWh usable storage, which means a slightly higher nominal battery capacity when accounting for depth-of-discharge limits (explained below).</p>
<p><strong>Power (kW) Requirements:</strong> In addition to energy (kWh), the system must handle the peak power draw of the home. A rough estimate for a typical family home with major appliances might be 5–8 kW peak load (higher if electric stoves or multiple air-cons run simultaneously). The inverter and panel array should be sized to comfortably supply this peak. We will target an inverter around <strong>8–10 kVA</strong> to ensure the system can deliver sufficient power for typical household loads without bottleneck.</p>
</section>
<section id="solar-pv-array-sizing" class="level3">
<h3 class="anchored" data-anchor-id="solar-pv-array-sizing">Solar PV Array Sizing</h3>
<p><strong>Energy Production Goal:</strong> To produce ~30 kWh per day from solar, we estimate the required PV capacity based on local solar irradiance. South Africa has good sunshine; assuming an average of about <strong>5 peak-sun-hours per day</strong>, a 1 kW solar array can produce roughly 5 kWh per day. Thus, to generate ~30 kWh/day, about <strong>6 kW_p</strong> (kilowatts peak) of panels are needed (30 kWh ÷ 5 kWh/kW ≈ 6 kW). In practice, we will oversize slightly to account for losses (inefficiencies, cloudy days, winter).</p>
<p><strong>Recommended PV Size:</strong> <strong>8 kW_p solar array</strong> – for example, ~20 panels of 400 W each. This size can produce on the order of 35–40 kWh on a good sunny day, providing a buffer to both run the house and charge the battery bank. (By comparison, a professionally designed off-grid system yielding ~42 kWh/day uses ~7.92 kW of panels (<a href="https://specializedsolarsystems.co.za/product-catalogue/ac-solar-power-solutions/10kva-7-920kwp-42kwh-per-day-with-32kwh-lifepo4-battery-off-grid-solar-system-copy/#:~:text=The%20solar,iron%20phosphate">Off grid solar kit | 10kVA inverter 7.92kWp 32kWh lithium</a>).) The 8 kW array ensures that even in <strong>winter or overcast conditions</strong>, there is a better chance to meet the 30 kWh load or at least partially recharge batteries. It also allows quick recharging of the 60 kWh battery after a prolonged outage, when the sun returns.</p>
<p><strong>Panel Type and Installation:</strong> We recommend <strong>high-efficiency monocrystalline PV panels</strong> (60 or 72-cell modules). These typically have 300–450 W output each; using ~72-cell (larger) panels reduces the number of modules needed (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=Solar%20cells%20,output%20300%20to%20375%20watts">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). Panels should be mounted on a <strong>north-facing roof</strong> (in the southern hemisphere) at an optimal tilt to maximize year-round solar exposure (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=In%20South%20Africa%2C%20solar%20panels,between%2025%20and%2040%20years">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). No specific brand is required; Tier-1 manufacturers (e.g.&nbsp;JA Solar, Trina, Jinko, Canadian Solar, etc.) offer similar efficiency (~18–21%) and reliability, so the focus is on cost-effective per-watt pricing and good warranty terms.</p>
<p><strong>Performance and Efficiency:</strong> The array will feed a MPPT (maximum power point tracking) charge controller or hybrid inverter, which manages the DC power from panels. Modern MPPT-enabled systems can achieve &gt;95% conversion efficiency of solar DC to battery storage or AC output. Some energy losses (maybe ~10-15%) are expected in cabling, controller, and inverter, which have been factored into the slight oversizing. The system should be designed such that during the day, solar directly powers the house and any surplus goes into charging the battery. Since <strong>export to the grid is not allowed</strong>, once the battery is full any further excess generation will be curtailed (essentially “wasted”). Thus, 8 kW_p is a reasonable compromise: large enough to meet needs but not so large that huge excesses occur regularly. In summer months there may be some midday surplus when the battery is full and loads are low; in winter, the array size will be just sufficient to cover usage on many days.</p>
</section>
<section id="battery-storage-system" class="level3">
<h3 class="anchored" data-anchor-id="battery-storage-system">Battery Storage System</h3>
<p><strong>Required Capacity:</strong> For a full 48-hour backup of 30 kWh/day, we target about <strong>60 kWh of usable storage</strong>. To achieve 60 kWh usable, the battery’s total capacity should be larger because it’s neither practical nor healthy for batteries to be fully discharged to 0%. Using a <strong>Lithium-ion (LiFePO₄) battery bank</strong>, we can safely discharge up to ~80–90% of the battery. Assuming ~80% Depth of Discharge (DoD) for longevity, the total installed battery capacity should be around:<br>
[ = ]<br>
This ensures 60 kWh is available without pushing the battery to absolute empty. In an emergency outage, the system could go deeper if needed, but designing for 80% DoD gives a margin and extends battery life (<a href="https://revov.co.za/news/load-shedding-solutions-what-size-backup-battery-do-i-need/#:~:text=As%20you%20continue%20the%20calculation,used%20according%20to%20manufacture%20recommendations">Load-Shedding Solutions | What Size Backup Battery Do I Need? - REVOV Battery Backup Power Solutions</a>) (<a href="https://ecotreelithium.co.uk/news/lifepo4-battery-cycle-life-and-durability/#:~:text=Understanding%20the%20%E2%80%98discharged%20state%E2%80%99%20is,DoD">LiFePO4 Battery Cycle Life &amp; Durability</a>).</p>
<p><strong>Battery Type:</strong> We recommend <strong>Lithium Iron Phosphate (LiFePO₄)</strong> batteries. LiFePO₄ is widely used in solar applications for its long life and safety. Compared to traditional lead-acid batteries, lithium batteries offer: higher usable depth of discharge, more cycle life, no required maintenance (no topping up acid), no gas emissions, lighter weight, and better charge efficiency (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=There%E2%80%99s%20no%20doubt%20that%20a,comparison%2C%20the%20many%20benefits%20include">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). They also can charge faster and don’t need to be fully recharged each cycle (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=,higher%20capacity">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). While upfront cost per kWh is higher than lead-acid, the longevity and usable capacity make them <strong>more cost-effective over the system life</strong>. A typical Li-ion solar battery comes with a <strong>10-year warranty</strong> and &gt;5,000 cycle lifespan (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=,year%20warranty">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>) (<a href="https://ecotreelithium.co.uk/news/lifepo4-battery-cycle-life-and-durability/#:~:text=What%20is%20the%20Cycle%20Life,of%20a%20LiFePO4%20Battery">LiFePO4 Battery Cycle Life &amp; Durability</a>). For example, good quality LiFePO₄ batteries can exceed 5,000 cycles at 80% DoD (<a href="https://ecotreelithium.co.uk/news/lifepo4-battery-cycle-life-and-durability/#:~:text=What%20is%20the%20Cycle%20Life,of%20a%20LiFePO4%20Battery">LiFePO4 Battery Cycle Life &amp; Durability</a>), which equates to roughly 13–15 years of daily cycling. This far outlives lead-acid banks, which might only get a few hundred deep cycles before needing replacement.</p>
<p><strong>Battery Bank Configuration:</strong> ~75 kWh is a very large battery bank. In practice, this would be built by connecting <strong>multiple modular battery units in parallel</strong>. Many LiFePO₄ solar batteries come in 5 kWh or 10 kWh modules (often 48V each). For instance, the system could use around five 15 kWh modules, or seven to eight 10 kWh modules, etc., connected to total ~75 kWh. This modular approach also allows some scalability – the homeowner could start with a bit less capacity if needed for budget, then add modules later (since lithium systems are <strong>easy to scale</strong> as needed (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=,year%20warranty">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>)).</p>
<p><strong>Cost-Effective Options:</strong> There are South African brands and products that provide large LiFePO₄ batteries at competitive prices. For example, <strong>Freedom Won</strong> (a SA manufacturer) offers high-capacity LiFePO₄ batteries (their “Freedom Lite” 48V units) – a 32 kWh usable unit (40 kWh nominal) with 10-year warranty is one such model (<a href="https://specializedsolarsystems.co.za/product-catalogue/ac-solar-power-solutions/10kva-7-920kwp-42kwh-per-day-with-32kwh-lifepo4-battery-off-grid-solar-system-copy/#:~:text=This%20off,up%20of%20the%20following%20equipment">Off grid solar kit | 10kVA inverter 7.92kWp 32kWh lithium</a>). <strong>Pylontech</strong> (a popular brand) provides 3.5 kWh modules that can be stacked; though many would be needed for 60+ kWh, they are known for reliability. <strong>Second-life EV batteries</strong> are another cost-saving option: companies repurpose electric vehicle battery packs for home storage at lower cost per kWh (with somewhat reduced lifetime). Given the budget constraint, exploring a reputable second-life lithium battery supplier could significantly cut costs while still providing the required capacity.</p>
<p><strong>Operating Strategy:</strong> Normally, the battery will charge from solar during the day and discharge at night to supply the home. This achieves maximum self-consumption of solar energy (since no selling back). The system can be configured such that the battery <strong>prioritizes critical loads during outages</strong>, extending its effective backup time. For example, during a long outage, heavy non-essential loads (pool pumps, laundry heaters, etc.) can be turned off to conserve power, allowing essential loads to run for 48 hours or more. A 60 kWh usable battery could theoretically power <em>all</em> 30 kWh/day usage for 2 days, but prudent load management during outages will provide a buffer (e.g.&nbsp;a 10 kWh battery can last 2–3 days for very basic needs (<a href="https://revov.co.za/news/load-shedding-solutions-what-size-backup-battery-do-i-need/#:~:text=How%20long%20will%20a%2010,kWh%20backup%20battery%20system%20last">Load-Shedding Solutions | What Size Backup Battery Do I Need? - REVOV Battery Backup Power Solutions</a>)). Our design ensures that in normal operation, the battery is cycled moderately (not 100% every day unless needed) to prolong its life.</p>
</section>
<section id="inverter-and-balance-of-system-components" class="level3">
<h3 class="anchored" data-anchor-id="inverter-and-balance-of-system-components">Inverter and Balance of System Components</h3>
<p><strong>Hybrid Inverter/Charger:</strong> A <strong>hybrid inverter</strong> is required to tie everything together. This device inverts DC power from the panels/battery to AC for household use, and can also charge the batteries from either solar or grid when needed. A unit in the <strong>8–10 kVA</strong> range is appropriate to handle the home’s peak loads. For example, a <strong>10 kVA (8 kW)</strong> inverter was used in a reference off-grid system for ~42 kWh/day consumption (<a href="https://specializedsolarsystems.co.za/product-catalogue/ac-solar-power-solutions/10kva-7-920kwp-42kwh-per-day-with-32kwh-lifepo4-battery-off-grid-solar-system-copy/#:~:text=The%20solar,iron%20phosphate">Off grid solar kit | 10kVA inverter 7.92kWp 32kWh lithium</a>), which aligns well with our needs. Good brands include Victron (high-end), Sunsynk, GoodWe, SMA, and Deye among others – many offer integrated solutions that combine an MPPT solar charge controller, battery management, and grid transfer switching in one device (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=Some%20inverters%20are%20all,power%20sources%20and%20computerised%20operation">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). This simplifies installation and provides <strong>seamless switchover</strong> to battery during outages (uninterruptible power supply function).</p>
<p>The inverter should output <strong>230V AC, 50 Hz</strong> to match the South African grid. It also serves as the system’s brains: managing battery charge, preventing over-discharge, and throttling solar input if the battery is full and grid export is disallowed. Modern inverters operate at high efficiency (~95–98% conversion efficiency) and produce a pure sine-wave AC output. A quality inverter will have <strong>smart controls</strong> (often with a web/app interface to monitor performance and configure settings).</p>
<p><strong>Charge Controller:</strong> If the chosen inverter does not have built-in MPPT, a separate <strong>solar charge controller</strong> would be needed. This device ensures the panels charge the battery optimally, adjusting voltage/current and preventing overcharge (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=Charger%20control">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). In our case, many hybrid inverters include MPPT functionality sized for the PV array, so we assume an all-in-one unit. The charge controller (standalone or inside inverter) will be sized for the array current – for 8 kW PV, that might be ~2 x 100A MPPTs (if split into strings), or one larger MPPT that can handle ~150–170 A input at battery voltage.</p>
<p><strong>Other Equipment:</strong> The system also requires <strong>balance-of-system</strong> components: mounting racks for panels, wiring, combiner boxes and disconnects, fuses/breakers, and a <strong>battery management system (BMS)</strong> (the BMS is typically integrated with lithium batteries, ensuring cells are balanced and protecting from over/under-charge). Safety features include surge protection and earth leakage protection. Given the scale of the battery, a <strong>proper enclosure</strong> or battery room is needed (lithium batteries don’t emit gas, so no special ventilation is needed (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=,maintenance%20free">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>), but temperature should be kept moderate for longevity).</p>
<p><strong>Component Lifespans:</strong> The <strong>solar panels</strong> are very long-lived – most carry 25-year performance warranties and can last 25–40 years (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=In%20South%20Africa%2C%20solar%20panels,between%2025%20and%2040%20years">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). After 25 years a panel typically still produces ~80% of its original output. <strong>Lithium battery banks</strong> have a lifespan on the order of 10–15 years under daily cycling (with warranties ~10 years) (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=,year%20warranty">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). After that, the capacity might drop to ~70-80% of original, at which point the homeowner might replace or augment the battery. The <strong>inverter</strong> is often the limiting component – good inverters last about <strong>10 to 15 years</strong> (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=Some%20inverters%20are%20all,power%20sources%20and%20computerised%20operation">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>), so it may require one replacement over a 25-year project span. Smaller components (charge controllers, etc.) should also last 10+ years if they are high quality. Regular maintenance is minimal for this setup: cleaning panels occasionally, and possibly replacing cooling fans or checking connections on the inverter. The lack of moving parts in panels and the maintenance-free nature of LiFePO₄ batteries keep ongoing upkeep low.</p>
</section>
<section id="financial-analysis" class="level3">
<h3 class="anchored" data-anchor-id="financial-analysis">Financial Analysis</h3>
<p>Investing in this solar-plus-battery system has significant upfront costs but yields long-term savings on electricity bills and protection from load-shedding. Below we break down the financial outlook:</p>
<p><strong>Upfront Cost Estimate (R):</strong> The budget is R200,000 (approximately $11,000). This needs to cover equipment and installation. Based on current market prices in South Africa, this budget is <strong>realistic for a 25–30 kWh/day off-grid-capable system</strong> (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=If%20you%20have%20a%20four,R200%2C000%20to%20R250%2C000%2C%20including%20installation">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>), though it requires careful component choices. For context, a typical 25 kWh/day off-grid setup with batteries costs around R200k–R250k installed (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=If%20you%20have%20a%20four,R200%2C000%20to%20R250%2C000%2C%20including%20installation">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>). Our system is slightly larger (30 kWh/day and more storage), so cost optimization is key (e.g., choosing a slightly smaller initial battery or competitive suppliers). A possible allocation of the budget could be:</p>
<ul>
<li>~R80,000 for 8 kW of solar panels (at ~R10/W including mounting hardware),<br>
</li>
<li>~R100,000 for ~60 kWh of battery storage (this assumes ~R1,600 per kWh, which might involve second-life batteries or a good bulk deal),<br>
</li>
<li>~R20,000 for a hybrid inverter and balance-of-system (some inverter models in the 8kW range cost ~R15k–R30k).</li>
</ul>
<p>These are rough figures and prices vary, but it shows achieving the system near R200k is feasible. If premium brand batteries/inverter are chosen, costs could exceed the budget (and one might opt for ~40 kWh battery initially to stay under budget, accepting a bit less than 48h backup except for essential loads).</p>
<p><strong>Electricity Bill Savings:</strong> With solar supplying ~30 kWh each day, the homeowner will purchase far less energy from the grid. At the given grid tariff of <strong>R3.35 per kWh</strong>, 30 kWh/day corresponds to <strong>R100.5 per day</strong> avoided cost. Over a year, that is about <strong>R36,700 per year</strong> in savings (30×R3.35×365). In practice, the savings could vary: if occasional bad weather forces some grid use, the savings might be slightly lower; conversely, if electricity prices inflate, the monetary savings increase. Importantly, these savings assume all solar energy is self-consumed (which our design facilitates by storing excess in the battery for night use). Since no excess can be sold, we sized the system such that generation roughly matches usage to maximize utilization. Any small surplus solar (when the battery is full on a sunny day) is “lost” because it cannot be exported – but this is a minor sacrifice for ensuring enough capacity for cloudy days.</p>
<p><strong>Payback Period (Simple):</strong> The <strong>simple payback time</strong> can be estimated as the initial cost divided by annual savings. Using R200,000 cost and ~R36,700/year savings, we get:</p>
<p><span class="math display">\[\text{Payback (no interest)} = \frac{R200,000}{R36,700/year} \approx 5.5 \text{ years}.\]</span></p>
<p>This means in roughly five and a half years, the cumulative electricity cost savings equal the upfront investment. This is a very favorable payback — notably, just a decade ago, solar systems had ~20-year paybacks, but with today’s high power costs and improved tech, payback times under 5–6 years are now achievable (<a href="https://www.ennikestates.co.za/news/jozi-home-rental-market-is-well-set-for-an-uptrend/#:~:text=At%20that%20stage%2C%20the%20payback%C2%A0period%C2%A0on,grid%20was%20reportedly%2020%20years">Jozi home rental market is well set for an uptrend | Ennik Estates</a>). In fact, reports indicate that a R200k solar-plus-battery system can pay for itself in <strong>“less than five years” under current conditions (<a href="https://www.ennikestates.co.za/news/jozi-home-rental-market-is-well-set-for-an-uptrend/#:~:text=At%20that%20stage%2C%20the%20payback%C2%A0period%C2%A0on,grid%20was%20reportedly%2020%20years">Jozi home rental market is well set for an uptrend | Ennik Estates</a>)</strong>. Our calculation is in the same ballpark, and if grid electricity prices continue to rise faster than inflation (as has been the trend), the payback could accelerate further.</p>
<p><strong>Considering Opportunity Cost:</strong> We also account for the <strong>opportunity cost of capital</strong> – the idea that the R200k could have been invested elsewhere. The homeowner expects a return of inflation + 2% if that money were invested. In real terms (assuming inflation-adjusted), that’s about a <strong>2% real annual return</strong>. Factoring this in effectively means the solar investment should be compared to an alternative where the R200k earns ~R4,000 per year in real interest. When we account for this, the <em>net</em> benefit of the solar system each year is the electricity savings minus the forgone interest: approximately R36,700 – R4,000 = <strong>R32,700</strong> per year. Using this net savings for payback gives:</p>
<p><span class="math display">\[\text{Payback (with 2\% cost of capital)} \approx \frac{R200,000}{R32,700/year} \approx 6.1 \text{ years}.\]</span></p>
<p>So, <strong>including opportunity cost, the payback is about 6 years</strong>. In other words, in 6 years the electricity savings not only recoup the R200k, but also compensate for the lost investment growth. Another way to see it: the internal rate of return (IRR) of the solar project is much higher than 2% – in fact, roughly on the order of 15–20% ROI when considering the annual savings vs cost, which far outstrips a modest 2% investment gain. Thus, even with conservative financial considerations, the solar system is a sound investment.</p>
<p><strong>Long-Term Savings:</strong> After the payback period, the system will continue to save ~R36k+ per year (and likely more in nominal terms if utility rates rise). Over a 25-year lifespan of panels, the <strong>cumulative savings</strong> can be on the order of R1 million (not inflation-adjusted) if power tariffs increase. Of course, one must account for <strong>battery replacement costs</strong> around year 10–15 (which might be another R100k or so in future Rands, though future battery prices may drop). Even so, the net present value (NPV) remains strongly positive. Additionally, there are <strong>intangible benefits</strong> not monetized in the payback: the ability to keep the lights on and appliances running during Eskom load-shedding or outages. This resilience has value in avoiding lost productivity, spoiled food, or the need for alternative backup generators.</p>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p><strong>Recommended Solution:</strong> Deploy an ~<strong>8 kW</strong> solar PV array, a <strong>lithium-ion battery bank ~60 kWh usable</strong> (75 kWh nominal), and an <strong>8–10 kVA hybrid inverter</strong>. This configuration can supply the home’s 30 kWh daily needs and provide approximately 48 hours of autonomy during grid outages. The system components were chosen for efficiency and longevity: Tier-1 PV modules (25-year life), a LiFePO₄ battery (10+ year life, &gt;5000 cycles (<a href="https://ecotreelithium.co.uk/news/lifepo4-battery-cycle-life-and-durability/#:~:text=What%20is%20the%20Cycle%20Life,of%20a%20LiFePO4%20Battery">LiFePO4 Battery Cycle Life &amp; Durability</a>)), and a quality inverter (10-15 year life). The design avoids feeding power to the grid, instead storing excess solar in batteries for nighttime use, thereby maximizing self-consumption. At an estimated cost of ~R200k (installed), the system fits the budget by using cost-effective equipment and possibly leveraging modular expansion.</p>
<p><strong>Performance:</strong> Under typical sun conditions, the solar panels will produce around 30–40 kWh per day (<a href="https://specializedsolarsystems.co.za/product-catalogue/ac-solar-power-solutions/10kva-7-920kwp-42kwh-per-day-with-32kwh-lifepo4-battery-off-grid-solar-system-copy/#:~:text=The%20solar,iron%20phosphate">Off grid solar kit | 10kVA inverter 7.92kWp 32kWh lithium</a>), meeting the household demand and charging the battery to prepare for night or any outages. During an outage, the system can run critical loads for 2 days comfortably, and with sunlight each day, essential usage can be maintained even beyond 48 hours (especially if non-critical loads are managed). This ensures the homeowner is largely shielded from load-shedding disruptions.</p>
<p><strong>Financial Return:</strong> The solar investment is financially attractive. With a ~5–6 year payback period from electricity savings, it yields a strong return compared to the modest 2% real growth of money in a bank. The savings on electricity bills (on the order of R35k per year) effectively start <strong>paying back from day one</strong>, and once the system is paid off, the continued savings are like tax-free dividends. Given that current payback periods in South Africa for similar systems are reported to be well under 5 years (<a href="https://www.ennikestates.co.za/news/jozi-home-rental-market-is-well-set-for-an-uptrend/#:~:text=At%20that%20stage%2C%20the%20payback%C2%A0period%C2%A0on,grid%20was%20reportedly%2020%20years">Jozi home rental market is well set for an uptrend | Ennik Estates</a>) (<a href="https://revov.co.za/news/what-you-need-for-an-off-grid-solar-system-in-south-africa/#:~:text=Despite%20this%2C%20the%20ever,repaid%20within%20just%20five%20years">What You Need for an Off-Grid Solar System in South Africa - REVOV Battery Backup Power Solutions</a>), this project is likely to recover its cost well within the components’ lifespan, even after accounting for battery replacement down the line.</p>
<p>In summary, the proposed solar PV and battery system is <strong>feasible within the R200k budget</strong>, meets the energy and backup requirements, and offers both economic and practical benefits. It will provide reliable power (with independence from grid outages) and long-term cost savings. The homeowner will enjoy peace of mind with a sustainable system that over its life will pay for itself and more.</p>
</section>
</section>
<section id="streamlit-application" class="level2">
<h2 class="anchored" data-anchor-id="streamlit-application">Streamlit Application</h2>
<p>The model also built a Streamlit application to help me calculate the payback time of the system. You can access the application <a href="https://solar-systems.streamlit.app/">here</a>.</p>
<p>There are quite a number of assumptions that I still need to work through…</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/interludeone\.com\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>