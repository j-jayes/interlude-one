{
  "hash": "90f939eca6671f9aeba5d69260f902f6",
  "result": {
    "markdown": "---\ntitle: \"Geocoding: two ways\"\ndescription: |\n  A post about geocoding place names using R and python to access the OSM and Google Maps geocoding APIs.\nimage: preview.png\nauthor:\n  - name: Jonathan Jayes\ndate: 2023-10-02\nformat: html\nexecute: \n  echo: true\n---\n\n\n\n\n## Introduction\n\n:::: {.columns}\n\n::: {.column width=\"65%\"}\nLocating places of interest on a map is an important task in many economic history projects. This tutorial will show you how to geocode a list of addresses.\n\nI will use both R and python to show you how to do this, depending on your preference and what you are most comfortable with.\n:::\n\n::: {.column width=\"5%\"}\n\n:::\n\n::: {.column width=\"30%\"}\n![A beautiful oil painting of a mosaic of a map or a city plan in the unique texture and color palette of Gustav Caillebotte](preview.png){width=80%}\n:::\n\n::::\n\n## Getting started\n\nThere are many engines that you can use to geocode place names or addresses to coordinates, some popular engines include the Open Street Map Nominatim API and the Google Maps API. \n\nConceptually, there is a distinction between the code that you use to call the engine which gets the coordinates (R or python), and then there is the engine itself (OSM or Google Maps).\n\n:::{.column-page}\n\n| Framework | R (tidygeocoder) & Open Street Map Nominatim API | Python (requests) & Google Maps Geocoding API |\n|-----------|---------------------------------------------------|------------------------------------------------|\n| **Geocoding Engine** | Open Street Map’s Nominatim | Google Maps Geocoding |\n| **Request Method** | Uses the `tidygeocoder` R package to send requests. | Uses the `requests` Python library to send HTTP requests. |\n| **Cost** | Free and open-source, but has usage policies to prevent heavy traffic. | Offers limited free requests, billing is required for extensive usage. |\n\n:::\n\nI use the `tidygeocoder` package in R, which is free, and the Google Maps Geocoding API in python, which is also free (up to some threshold), but requires an API key from Google and a credit card to sign up.^[You can also use the Google Maps Geocoding API in R through the `tidygeocoder` package, but you will still need to sign up for an API key from Google.]\n\nYou can read about getting an API key [here](https://developers.google.com/maps/documentation/geocoding/get-api-key).\n\n## Data\n\nFor the purpose of this tutorial, I have generated 20 place names to geocode and a column of arbitrary values for visualization.\n\n\n| Place Name       | Arbitrary Value |\n|------------------|-----------------|\n| Stockholm        | 35              |\n| Gothenburg       | 12              |\n| Malmö            | 27              |\n| Uppsala          | 19              |\n| Västerås         | 22              |\n| Örebro           | 15              |\n| Linköping        | 20              |\n| Helsingborg      | 24              |\n| Norrköping       | 28              |\n| Jönköping        | 17              |\n| Lund             | 23              |\n| Umeå             | 10              |\n| Gävle            | 18              |\n| Borås            | 14              |\n| Eskilstuna       | 16              |\n| Södertälje       | 13              |\n| Karlstad         | 21              |\n| Täby             | 29              |\n| Växjö            | 11              |\n| Halmstad         | 26              |\n\n\n## R and tidygeocoder\n\nJesse Cambon has kindly made a package called `tidygeocoder` available on [github](https://jessecambon.github.io/tidygeocoder/).\n\nYou can install it on your computer using the following code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages('tidygeocoder')\n```\n:::\n\n\nHere is how you geocode a list of addresses using the `tidygeocoder` package.\n\nNote that `lat` and `long` here will be the column names for the coordinates that are returned.\n\nThe line `method = \"osm\"` specifies that we are using the Open Street Map Nominatim API. Here you can switch to another engine if you prefer.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # for data manipulation\nlibrary(tidygeocoder) # for geocoding\n\n# Read in data\nlibrary(readxl) # for reading excel files\nplaces <- read_excel(\"data/data_to_geocode.xlsx\")\n\n# Geocode places\nplaces_geocoded <- places %>%\n    geocode(place_name,\n        method = \"osm\",\n        lat = latitude,\n        long = longitude\n    )\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nThis what the output looks like when the geocoding is complete.\n\n<blockquote>\nPassing 20 addresses to the Nominatim single address geocoder\n[===================================] 20/20 (100%) Elapsed: 20s Remaining:  0s\n</blockquote>\n\nWe can visualize the results using the `ggplot2` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Find bounds to trim map, adding some padding\nbounds <- places_geocoded %>%\n    summarise(xmin = min(longitude) - 0.1,\n              xmax = max(longitude) + 0.1,\n              ymin = min(latitude) - 0.1,\n              ymax = max(latitude) + 0.1)\n\n# Plot places\nggplot(places_geocoded, aes(longitude, latitude), color = \"grey99\") +\n    borders() +\n    geom_point(aes(size = arbitrary_value), colour = \"midnightblue\") +\n    ggrepel::geom_label_repel(aes(label = place_name)) +\n    theme_void() +\n    coord_cartesian(xlim = c(bounds$xmin, bounds$xmax), \n                    ylim = c(bounds$ymin, bounds$ymax)) +\n    labs(size = \"Arbitrary value\")\n```\n\n::: {.cell-output-display}\n![](geocoding_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nGreat! We have successfully geocoded our list of addresses.\n\n## Geocoding in python\n\nI have created a Colab notebook that shows you how to geocode addresses using the Google Maps Geocoding API in python. You can simply run the code in the notebook to get the coordinates of your own data by providing your own API key and data.\n\nYou can have a look at the Colab notebook [here](https://colab.research.google.com/drive/1Pi7Qv6fUW3NwhtDIiRSVyhS9qKMoXO4R?usp=sharing)\n\n<script src=\"https://gist.github.com/j-jayes/b5c1108cdb8da134d6552ef185dbf787.js\"></script>\n\n## Real world use case\n\nIn reality, it will likely not be as simple as running the above code once and getting all the coordinates you need.\n\nYou will likely need to do multiple passes, modify addresses, and evaluate the results.\n\nMultiple passes are necessary to maximize the accuracy and success rate of geocoding. The initial pass may not successfully geocode all addresses due to inaccuracies, ambiguities, or limitations of the geocoding tool. By modifying the problematic addresses and doing subsequent passes, you can resolve these issues and geocode more addresses correctly.\n\nFor example, an address might fail to geocode because it contains a typo, is too specific, or too ambiguous. By modifying the address to correct the typo or by making it more general or more specific, it might geocode successfully in a subsequent pass.\n\nThe term \"out of bounds\" in the context of geocoding refers to the geocoded results that do not fit within a predefined geographical area or are not reasonable based on prior knowledge. For instance, if you are geocoding addresses in Sweden, any result that lies outside the borders of Sweden would be considered \"out of bounds.\"\n\nIn practical terms, if you know the general area where the addresses should be located (like a specific country or city), you can compare the geocoded results against this area. If the geocoded location falls outside this area, it is considered out of bounds, and you might need to modify the address and try geocoding it again, or use a different geocoding engine that might provide more accurate results.\n\nHere is a diagram that shows the real world process of geocoding in more detail.\n\n\n```{mermaid}\n%%| echo: false\n\nstateDiagram-v2\n    [*] --> FirstPass\n    FirstPass --> StoreResults: In bounds\n    FirstPass --> ModifyAddresses: Out of bounds\n    \n    ModifyAddresses --> SecondPass\n    \n    SecondPass --> StoreSecondPassResults: In bounds\n    SecondPass --> Evaluate: Out of bounds\n    \n    StoreResults --> Evaluate\n    StoreSecondPassResults --> Evaluate\n    \n    Evaluate --> ManualGeocode: Handful left\n    Evaluate --> TryDifferentEngine: Many left\n    \n    ManualGeocode --> FinalResults\n    TryDifferentEngine --> FinalResults\n    \n    FinalResults --> [*]\n\n```\n\n\n### 1. **First Pass**  \n- **Objective:**  To attempt an initial conversion of place names or addresses into geographical coordinates. \n- **Example:**  If you have a list of street addresses in Sweden, you use a geocoding tool to convert these addresses into geographical coordinates. \n- **Outcome:**  Some addresses will be successfully geocoded within the reasonable bounds (i.e., within Sweden), and some may not be (i.e., places outside Sweden).\n\n### 2. **Modify Addresses**  \n- **Objective:**  To modify the addresses that were not successfully geocoded in the first pass. \n- **Example:**  If an address, \"123 Main St, Stockholm,\" fails in the first pass, you might modify it to just \"Stockholm\" or append the country, \"123 Main St, Stockholm, Sweden.\" \n- **Outcome:**  The modified addresses are ready for the second pass.\n\n### 3. **Second Pass**  \n- **Objective:**  To attempt the conversion again with the modified addresses. \n- **Outcome:**  More addresses will be successfully geocoded within the reasonable bounds.\n\n### 4. **Evaluate Results**  \n- **Objective:**  To assess the number of addresses that are left un-geocoded after the second pass. \n- **Outcome:**  Determine whether manual geocoding or trying a different geocoding engine is needed.\n\n### 5. **Manual Geocode or Try Different Engine**  \n- **Objective:**  To geocode the remaining un-geocoded addresses. \n- **Example:**  If there are only a few addresses left, you might geocode them by hand using online maps. If there are many addresses left, you might switch to a different geocoding engine, e.g., from Open Street Map to Google Maps. \n- **Outcome:**  All addresses are successfully geocoded.\n\n### 6. **Final Results**  \n- **Objective:**  To obtain a complete list of geographical coordinates corresponding to the initial list of place names or addresses. \n- **Outcome:**  A successfully geocoded list is ready for further use or analysis.\n\n",
    "supporting": [
      "geocoding_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}